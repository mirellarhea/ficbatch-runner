name: Build Android & Windows and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v0.5.1)"
        required: true
      branch:
        description: "Branch to build from"
        required: true
        default: main

env:
  PARENT_REPO: aimatochysia/ficbatch

jobs:

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PARENT_REPO }}
          token: ${{ secrets.ORIGIN_PAT }}
          ref: ${{ github.event.inputs.branch }}

      - name: Set release tag (from user input)
        id: set-tag
        run: echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"

      - name: Clean & install dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Decode Android keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/ficbatch-release-key.jks

      - name: Write Android key.properties
        run: |
          cat > android/key.properties <<EOF
          storeFile=ficbatch-release-key.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      - name: Build Signed Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: cp build/app/outputs/flutter-apk/app-release.apk ficbatch.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: ficbatch.apk
          if-no-files-found: error


  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: build-android

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PARENT_REPO }}
          token: ${{ secrets.ORIGIN_PAT }}
          ref: ${{ github.event.inputs.branch }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Copy generated EXE
        run: |
          Copy-Item "build/windows/x64/runner/Release/ficbatch.exe" "ficbatch.exe" -Force

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: ficbatch.exe
          if-no-files-found: error


  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-windows]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.PARENT_REPO }}
          tag_name: ${{ github.event.inputs.version }}
          name: "Release ${{ github.event.inputs.version }}"
          body: |
            **Included Files**
            - ficbatch.exe (Windows)
            - ficbatch.apk (Android)
          token: ${{ secrets.ORIGIN_PAT }}
          files: release-dist/**/*
          overwrite_files: true
