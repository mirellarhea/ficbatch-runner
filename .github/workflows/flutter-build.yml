name: Build Android & Windows and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v0.5.1)"
        required: true
      branch:
        description: "Branch to build from"
        required: true
        default: main

env:
  PARENT_REPO: aimatochysia/ficbatch

jobs:

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PARENT_REPO }}
          token: ${{ secrets.ORIGIN_PAT }}
          ref: ${{ github.event.inputs.branch }}

      - name: Set release tag (from user input)
        id: set-tag
        run: echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.32.0

      - name: Clean & install dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Decode Android keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/ficbatch-release-key.jks

      - name: Write Android key.properties
        run: |
          cat > android/key.properties <<EOF
          storeFile=ficbatch-release-key.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      - name: Build Signed Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: cp build/app/outputs/flutter-apk/app-release.apk ficbatch-android.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: ficbatch-android.apk
          if-no-files-found: error


  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: build-android

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PARENT_REPO }}
          token: ${{ secrets.ORIGIN_PAT }}
          ref: ${{ github.event.inputs.branch }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.32.0

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Copy raw exe
        run: |
          Copy-Item "build/windows/x64/runner/Release/ficbatch.exe" "ficbatch-windows.exe" -Force

      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: pwsh

      - name: Create Inno Setup script
        shell: pwsh
        run: |
          $sourceDir = (Resolve-Path "build/windows/x64/runner/Release").Path
          $outDir = $pwd
          $iss = @"
          #define MyAppName "ficbatch"
          #define MyAppVersion "${{ github.event.inputs.version }}"
          #define OutputBase "ficbatch-windows-installer"
          #define SourceDir "$($sourceDir)"
          #define OutDir "$($outDir)"

          [Setup]
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          OutputBaseFilename={#OutputBase}
          OutputDir={#OutDir}
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "{#SourceDir}\*"; DestDir: "{app}"; Flags: recursesubdirs

          [Icons]
          Name: "{autoprograms}\ficbatch"; Filename: "{app}\ficbatch.exe"

          "@
          $issPath = "$env:RUNNER_TEMP\ficbatch-installer.iss"
          Set-Content -Path $issPath -Value $iss -Encoding UTF8

      - name: Build installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "$env:RUNNER_TEMP\ficbatch-installer.iss"

      - name: Rename installer
        shell: pwsh
        run: |
          Move-Item "ficbatch-windows-installer.exe" "ficbatch-windows-installer.exe" -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            ficbatch-windows.exe
            ficbatch-windows-installer.exe
          if-no-files-found: error


  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-windows]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.PARENT_REPO }}
          tag_name: ${{ github.event.inputs.version }}
          name: "Release ${{ github.event.inputs.version }}"
          body: |
            **Included Files**
            - ficbatch-windows.exe
            - ficbatch-windows-installer.exe
            - ficbatch-android.apk
          token: ${{ secrets.ORIGIN_PAT }}
          files: release-dist/**/*
          overwrite_files: true
